# (3) Quota 설정-1
## 1. 배경

Keystone 인증 검증으로 `unscoped/scoped token`을 발급 받았다. 

## 2. 개요

자원 할당 작업 전, 상한선 설정을 위한 Quota를 설정하는 작업이다.

이번 Quota 설정은 Nova, Cinder만 다루며, 추후 Network도 다루어야 할 것이다.

고안되는 Quota 설정 방안은 3가지이다.

- (방안 1) 학생마다 고정된 Quota 설정
- (방안 2) 2가지 Profile에 따라 Quota 설정 (기본(Basic) / 실습(Lab))
- (방안 3) 수업마다 학생 수에 기반해 Quota 설정 → 보다 유동적으로 설정

빠르게 자원 할당 / 회수 로직까지 도달하기 위해 (방안1)을 우선적으로 구현한 후, (방안2)(방안 3)까지 Go 서버 API로 제작하고자 한다. 

(방안 2)(방안 3)은 아래 페이지에서 진행한다.

[(4) Quota 설정-2](https://www.notion.so/4-Quota-2-254e19595aec80dea118ca065c41fb8d?pvs=21)

이번 작업부터는 OpenStack API Document를 레퍼런스로 참고하였다. 

[Compute API — nova  documentation](https://docs.openstack.org/api-ref/compute/)

[Block Storage API V3 (CURRENT) — cinder  documentation](https://docs.openstack.org/api-ref/block-storage/v3/)

## 3. 진행 과정

### 3-1. **Nova, Cinder 버전 디스커버리 확인**

```bash
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" http://192.168.64.4/compute/ | jq .
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" http://192.168.64.4/volume/  | jq .
```

![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image.png)

- Nova: `v2.1`가 CURRENT → 실제 호출은 `/compute/v2.1/...`
- Cinder: `v3`가 CURRENT (`version: 3.71`, `min_version: 3.0`) → 실제 호출은 `/volume/v3/...`

---

### 3-2. 트러블 슈팅 : 401 Unauthorized

발급한 SCOPED_TOKEN이 만료되어 401 리턴.

![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%201.png)

```bash
# scoped 토큰 재발급
SCOPED_TOKEN=$(curl -si -H 'Content-Type: application/json' \
-d '{
  "auth": {
    "identity": { "methods": ["password"], "password": { "user": {
      "name": "admin", "domain": { "id": "default" }, "password": "secret"
    }}},
    "scope": { "project": { "id": "144ba567a5db4334bce43a8c3b54f710" } }
  }
}' http://192.168.64.4/identity/v3/auth/tokens \
| awk -F': ' '/^X-Subject-Token:/ {print $2}' | tr -d '\r')

echo "token_len=${#SCOPED_TOKEN}"   # 길이 확인(빈값이면 실패)
```

---

### 3-3. Nova Quota 조회

> Nova(Compute) → vCPU(`cores`), RAM(`ram`), 인스턴스 수(`instances`) 등
> 
> 
> Cinder(Block Storage) → 디스크 총량(`gigabytes`), 볼륨 수(`volumes`), 스냅샷 수(`snapshots`)
> 

![[https://docs.openstack.org/api-ref/compute/?expanded=#quota-sets-os-quota-sets](https://docs.openstack.org/api-ref/compute/?expanded=#quota-sets-os-quota-sets)]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%202.png)

[https://docs.openstack.org/api-ref/compute/?expanded=#quota-sets-os-quota-sets](https://docs.openstack.org/api-ref/compute/?expanded=#quota-sets-os-quota-sets)

**실행 코드** 

```bash
curl -s -H "X-Auth-Token: $SCOPED_TOKEN"   http://192.168.64.4/compute/v2.1/os-quota-sets/$PROJECT_ID | jq .
```

- 실행 결과
    
    ![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%203.png)
    

---

### **3-4. Cinder Quota 조회**

- 공식 Cinder v3 레퍼런스는 이중 ID 스타일을 기준으로 함

![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%204.png)

> `/v3/{admin_project_id}/os-quota-sets/{project_id}`

`admin_project_id` 토큰이 스코프 된 프로젝트 id
`project_id`  쿼터를 조회 / 변경하려는 프로젝트 id
> 
> - admin_project_id 확인 코드
>     
>     ```bash
>     curl -s \
>       -H "X-Auth-Token: $SCOPED_TOKEN" \
>       -H "X-Subject-Token: $SCOPED_TOKEN" \
>       http://192.168.64.4/identity/v3/auth/tokens | jq '.token.project.id,.token.project.name'
>     ```
>     
> - project_id 확인 코드
>     
>     ```bash
>     curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
>       http://192.168.64.4/identity/v3/auth/projects | jq .
>     ```
>     

**(1) 환경 변수 설정** 

```bash
BASE_CINDER="http://192.168.64.4/volume/v3"
ADMIN_PID="144ba567a5db4334bce43a8c3b54f710"    # admin
DEMO_PID="7c779d5a593d4e11b22c614932802465"     # demo
```

**(2) admin 프로젝트 기본 쿼터 조회**

```bash
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$ADMIN_PID/defaults" | jq '.quota_set'
```

**(3) demo 프로젝트 기본 쿼터 조회** 

```bash
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$DEMO_PID/defaults" | jq '.quota_set'
```

**(4) demo 프로젝트 사용량 조회**

```bash
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$DEMO_PID?usage=true" | jq '.quota_set'
```

- (1)-(4) 실행 결과
    
    ![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%205.png)
    

---

### 3-5. Quota 설정: 롤백

학기 말 Quota 롤백을 위해, `nova_quota_backup.json` `cinder_quota_backup.json`  생성 

**(1) 환경 변수 설정**

```bash
BASE_NOVA="http://192.168.64.4/compute/v2.1"
BASE_CINDER="http://192.168.64.4/volume/v3"

ADMIN_PID="144ba567a5db4334bce43a8c3b54f710"   # 토큰이 스코프된 admin 프로젝트
TARGET_PID="7c779d5a593d4e11b22c614932802465"  # 수업(과목) 프로젝트 (예: demo)
```

**(2) backup.json 생성**

```bash
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_NOVA/os-quota-sets/$TARGET_PID" > nova_quota_backup.json

curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$TARGET_PID" > cinder_quota_backup.json
```

- (2) 실행 결과
    
    ![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%206.png)
    

**(3) 롤백: Nova**

![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%207.png)

```bash
# 보낼 바디(존재하는 키만 포함)
NOVA_BODY=$(jq -c '{quota_set: (
  {cores: .quota_set.cores, ram: .quota_set.ram, instances: .quota_set.instances}
  | with_entries(select(.value != null))
)}' nova_quota_backup.json)

echo "$NOVA_BODY" | jq .

curl -sS -X PUT \
  -H "X-Auth-Token: $SCOPED_TOKEN" \
  -H "Content-Type: application/json" \
  -d "$NOVA_BODY" \
  "$BASE_NOVA/os-quota-sets/$TARGET_PID" | jq '.quota_set | {cores, ram, instances}'
```

- (3) 실행 결과
    
    현재는 Default 값에서 바로 Rollback을 진행하여 동일한 값이 출력 됨. 
    3-5-2. Quota 재설정 후 Rollback 수행 결과를 참고. 
    
    ![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%208.png)
    

**(4) 롤백: Cinder**

![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%209.png)

```bash
# 백업에서 quota_set JSON 생성(필요 키만)
CINDER_BODY=$(jq -c '{quota_set: (.quota_set
  | del(.id)
  | with_entries(select(.key | test("___DEFAULT__$") | not))
)}' cinder_quota_backup.json)

# 최종 보낼 바디 확인
echo "$CINDER_BODY" | jq .   

# 롤백 적용
curl -sS -X PUT \
  -H "X-Auth-Token: $SCOPED_TOKEN" \
  -H "Content-Type: application/json" \
  -d "$CINDER_BODY" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$TARGET_PID" | jq '.quota_set'
```

**(5) 롤백 실행 검증**

```bash
# nova
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_NOVA/os-quota-sets/$TARGET_PID/detail" \
  | jq '.quota_set | {cores, ram, instances}'

#cinder
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$TARGET_PID?usage=true" \
  | jq '.quota_set | {gigabytes, volumes, snapshots}'
```

### 3-6. Quota 설정: (1) 고정 상수 값 설정

**(1) 환경 변수 설정**

```bash
BASE_NOVA="http://192.168.64.4/compute/v2.1"
BASE_CINDER="http://192.168.64.4/volume/v3"

ADMIN_PID="144ba567a5db4334bce43a8c3b54f710"   # 토큰이 스코프된 admin 프로젝트
TARGET_PID="7c779d5a593d4e11b22c614932802465"  # 수업(과목) 프로젝트 (예: demo)
```

**(2) Quota 업데이트** 

> vCPU=8, RAM=16GiB(=16384MB), Disk=100GB, Volumes=10, Snapshots=10
> 

```bash
# Nova: vCPU=8, RAM=16384MB
curl -sS -X PUT -H "X-Auth-Token: $SCOPED_TOKEN" -H 'Content-Type: application/json' \
  -d '{"quota_set":{"cores":8,"ram":16384}}' \
  "$BASE_NOVA/os-quota-sets/$TARGET_PID" | jq '.quota_set | {cores,ram}'

# Cinder: Disk=100GB, Volumes=10, Snapshots=10
curl -sS -X PUT -H "X-Auth-Token: $SCOPED_TOKEN" -H 'Content-Type: application/json' \
  -d '{"quota_set":{"gigabytes":100,"volumes":10,"snapshots":10}}' \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$TARGET_PID" | jq '.quota_set | {gigabytes,volumes,snapshots}'
```

![image.png]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%2010.png)

**(3) 실행 검증** 

```bash
# Nova 상세(현 limit & in_use)
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_NOVA/os-quota-sets/$TARGET_PID/detail" | jq '.quota_set | {cores,ram,instances}'

# Cinder 사용량 포함
curl -s -H "X-Auth-Token: $SCOPED_TOKEN" \
  "$BASE_CINDER/$ADMIN_PID/os-quota-sets/$TARGET_PID?usage=true" \
  | jq '.quota_set | {gigabytes,volumes,snapshots}'
```

![기존 Default Quota에서 변경된 것을 확인할 수 있다. ]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/image%2011.png)

기존 Default Quota에서 변경된 것을 확인할 수 있다. 

**(4) (추가 작업) 3-5 기반 Rollback 진행**

Quota가 초기 값으로 rollback 되었음을 확인하였다

![Rollback 진행 전]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/41c1219a-72eb-4260-96d3-16206a20a0a5.png)

Rollback 진행 전

![Rollback 진행 후]((3)%20Quota%20%EC%84%A4%EC%A0%95-1%20254e19595aec803c92d6da0a4cf0b53a/3e0dfb3c-61f2-455f-9282-e185980f1763.png)

Rollback 진행 후