# (5) 자원 관리: 준비

담당자: 이지수
진행 상태: 완료
프로젝트: 인프라 관리 솔루션 (https://www.notion.so/223e19595aec8024bd98e7341e341b90?pvs=21)
선행 작업: (4) Quota 설정-2 (https://www.notion.so/4-Quota-2-254e19595aec80dea118ca065c41fb8d?pvs=21)
후속 작업: (6) 자원 관리: 설계 (https://www.notion.so/6-25ce19595aec80a98db4f2395a1e8d61?pvs=21)

## 1. 준비 작업

- Keystone 토큰 발급 (AuthenticatedClient)
- Image / Flavor / Keypair / SecurityGroup 목록 확인

### 1-1. 클라이언트 생성

**(1) Image, Network 서비스 클라이언트 추가**

```go
// clients.go

package openstack

import (
	"fmt"

	"example.com/quotaapi/internal/config"
	"github.com/gophercloud/gophercloud/v2"
	"github.com/gophercloud/gophercloud/v2/openstack"
)

type Clients struct {
	Provider       *gophercloud.ProviderClient
	Identity       *gophercloud.ServiceClient
	ComputeV2      *gophercloud.ServiceClient
	BlockStorageV3 *gophercloud.ServiceClient
	ImageV2        *gophercloud.ServiceClient
	NetworkV2      *gophercloud.ServiceClient
	AdminProjectID string
	Region         string
}

func NewServiceClients(cfg *config.Config) (*Clients, error) {
	provider, ident, err := NewIdentity(cfg)
	if err != nil {
		return nil, fmt.Errorf("keystone auth: %w", err)
	}

	compute, err := openstack.NewComputeV2(provider, gophercloud.EndpointOpts{Region: cfg.RegionName})
	if err != nil {
		return nil, fmt.Errorf("new compute v2: %w", err)
	}

	block, err := openstack.NewBlockStorageV3(provider, gophercloud.EndpointOpts{
		Region:       cfg.RegionName,
		Type:         "block-storage",                // 카탈로그에 있는 type 과 맞춤
		Name:         "cinder",                       // (선택) name 일치시켜 매칭 더 확실
		Availability: gophercloud.AvailabilityPublic, // public endpoint 사용
	})
	if err != nil {
		return nil, fmt.Errorf("new blockstorage v3: %w", err)
	}

	image, err := openstack.NewImageV2(provider, gophercloud.EndpointOpts{Region: cfg.RegionName})
	if err != nil {
		return nil, fmt.Errorf("new image v2: %w", err)
	}

	network, err := openstack.NewNetworkV2(provider, gophercloud.EndpointOpts{Region: cfg.RegionName})
	if err != nil {
		return nil, fmt.Errorf("new network v2: %w", err)
	}

	return &Clients{
		Provider:       provider,
		Identity:       ident,
		ComputeV2:      compute,
		BlockStorageV3: block,
		ImageV2:        image,
		NetworkV2:      network,
		AdminProjectID: cfg.AdminProjectID,
		Region:         cfg.RegionName,
	}, nil
}

```

**(2) 클라이언트 정보 출력**

```go
package main

import (
	"context"
	"fmt"
	"log"
	"net/http"
	"os"

	"example.com/quotaapi/internal/config"
	httph "example.com/quotaapi/internal/http"
	osapi "example.com/quotaapi/internal/openstack"

	flavors "github.com/gophercloud/gophercloud/v2/openstack/compute/v2/flavors"
	keypairs "github.com/gophercloud/gophercloud/v2/openstack/compute/v2/keypairs"
	images "github.com/gophercloud/gophercloud/v2/openstack/image/v2/images"
	secgroups "github.com/gophercloud/gophercloud/v2/openstack/networking/v2/extensions/security/groups"
)

func main() {
	// 1) 환경 로드/검증
	cfg, err := config.Load()
	if err != nil {
		log.Fatalf("config error: %v", err)
	}

	// 2) 라우팅
	http.HandleFunc("/healthz", func(w http.ResponseWriter, r *http.Request) {
		httph.WriteJSON(w, http.StatusOK, map[string]any{"ok": true})
	})
	http.HandleFunc("/auth/check", httph.NewAuthCheckHandler(cfg))

	osc, err := osapi.NewServiceClients(cfg)
	if err != nil {
		log.Fatal(err)
	}

	// 2-1) 시작 시 토큰/기본 자원 목록 출력
	printBasics(osc)

	qget := &httph.QuotaGetServer{OS: osc}
	http.HandleFunc("/quota/current", qget.Current)

	srv := &httph.QuotaApplyServer{OS: osc}
	http.HandleFunc("/quota/apply", srv.QuotaApply)

	http.HandleFunc("/quota/applyProfile", httph.NewApplyProfileHandler(osc))

	// 3) 서버 시작
	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
	}
	log.Printf("server listening on :%s", port)
	log.Fatal(http.ListenAndServe(":"+port, nil))
}

// service client 출력 
func printBasics(osc *osapi.Clients) {
	ctx := context.Background()
	fmt.Printf("Issued Token ID: %s\n", osc.Provider.TokenID)

	// Images (Glance)
	fmt.Println("--- Images ---")
	if pages, err := images.List(osc.ImageV2, images.ListOpts{}).AllPages(ctx); err == nil {
		if list, err := images.ExtractImages(pages); err == nil {
			for _, img := range list {
				fmt.Printf("ID: %s, Name: %s\n", img.ID, img.Name)
			}
		} else {
			fmt.Printf("images extract error: %v\n", err)
		}
	} else {
		fmt.Printf("images list error: %v\n", err)
	}

	// Flavors (Nova)
	fmt.Println()
	fmt.Println("--- Flavors ---")
	if pages, err := flavors.ListDetail(osc.ComputeV2, flavors.ListOpts{}).AllPages(ctx); err == nil {
		if list, err := flavors.ExtractFlavors(pages); err == nil {
			for _, f := range list {
				fmt.Printf("ID: %s, Name: %s, vCPUs: %d, RAM: %dMB, Disk: %dGB\n", f.ID, f.Name, f.VCPUs, f.RAM, f.Disk)
			}
		} else {
			fmt.Printf("flavors extract error: %v\n", err)
		}
	} else {
		fmt.Printf("flavors list error: %v\n", err)
	}

	// Keypairs (Nova)
	fmt.Println()
	fmt.Println("--- Keypairs ---")
	if pages, err := keypairs.List(osc.ComputeV2, keypairs.ListOpts{}).AllPages(ctx); err == nil {
		if list, err := keypairs.ExtractKeyPairs(pages); err == nil {
			for _, k := range list {
				fmt.Printf("Name: %s, Fingerprint: %s\n", k.Name, k.Fingerprint)
			}
		} else {
			fmt.Printf("keypairs extract error: %v\n", err)
		}
	} else {
		fmt.Printf("keypairs list error: %v\n", err)
	}

	// Security Groups (Neutron)
	fmt.Println()
	fmt.Println("--- Security Groups ---")
	if pages, err := secgroups.List(osc.NetworkV2, secgroups.ListOpts{}).AllPages(ctx); err == nil {
		if list, err := secgroups.ExtractGroups(pages); err == nil {
			for _, g := range list {
				fmt.Printf("ID: %s, Name: %s, Description: %s\n", g.ID, g.Name, g.Description)
			}
		} else {
			fmt.Printf("secgroups extract error: %v\n", err)
		}
	} else {
		fmt.Printf("secgroups list error: %v\n", err)
	}
}
```

**(3) 실행 확인**

```go
go run .
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image.png)

**각 클라이언트 역할**

- Provider: Keystone 인증 상태/토큰 보관(모든 서비스 호출의 기반)
- Identity: Keystone Identity v3 API 호출용(토큰 인트로스펙트 등)
- ComputeV2: Nova API(플레이버 조회, 인스턴스 생성/삭제, 키페어 관리)
- BlockStorageV3: Cinder API(볼륨/스냅샷 쿼터·리소스)
- ImageV2: Glance API(이미지 목록/메타데이터)
- NetworkV2: Neutron API(보안그룹, 네트워크/서브넷/포트)

---

### 1-2. VM 환경 설정

```bash
sudo vi ~/.openstackrc
```
export OS_AUTH_URL=http://192.168.64.4/identity/v3
export OS_USERNAME=admin
export OS_PASSWORD=secret
export OS_PROJECT_NAME=admin
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
```

source ~/.openstackrc 
chmod 600 ~/.openstackrc
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%201.png)

---

## 2. 부트스트랩 (공통 항목 초기 설정)

VM을 만들 때 매번 필요한 공통 항목을 설정한다.

- **키페어**: SSH 접속용 공개키 등록 → VM에 주입해 로그인 가능
- **보안그룹**: 최소 인바운드(SSH 22, ICMP) 허용
- **네트워크**: `private`(내부) + `public`(외부) + **라우터** 연결 확인
- **플로팅 IP 풀**: 외부 접속 필요 시 public 네트워크가 External로 잡혀 있어야 함
- **쿼터**: 인스턴스/FIP/포트/볼륨 만들 여유 확인

초기 한 번 설정하면 되므로, 직접 VM 내부에 접속하여 설정을 진행한다. 

---

### **2-1. 키페어 생성/등록 (SSH 접속용 공개키 등록)**

VM 생성 시 키페어를 주입해 SSH 무비밀번호 접속을 가능하게 하기 위함이다. 

```bash
mkdir -p ~/.ssh && chmod 700 ~/.ssh
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
openstack keypair create --public-key ~/.ssh/id_ed25519.pub my-key
openstack keypair list
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%202.png)

---

### 2-2. 보안그룹 생성 + 최소 인바운드 규칙(SSH/ICMP)

기본적으로 막혀 있는 인바운드 트래픽 중 SSH(22)와 ping(ICMP)을 허용한다. 

**(1) 보안그룹 설정 및 인바운드 규칙 추가**

- 보안그룹 생성: default-ssh 생성
- 인바운드 규칙 추가
    - SSH: TCP 22, IPv4, 0.0.0.0/0 허용
    - ICMP: IPv4, 0.0.0.0/0 허용

```bash
openstack security group create default-ssh --description "SSH/ICMP"
openstack security group rule create --ingress --protocol tcp --dst-port 22 default-ssh
openstack security group rule create --ingress --protocol icmp default-ssh
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%203.png)

**(2) 실행 확인**

```bash
openstack security group list
openstack security group show default-ssh
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%204.png)

---

### 2-3. 네트워크/라우터/플로팅 IP 풀 확인

**(1) 네트워크/외부망 속성 확인**

```bash
openstack network list
openstack network show public -f json | jq '{name:.name,id:.id,is_external:."router:external"}'
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%205.png)

- Neutron 네트워크 목록
- `shared`: 서브넷 1개가 붙은 네트워크.
- `private`: 서브넷 2개가 붙어 있음(예: v4+v6 혹은 서로 다른 v4 대역).
- `public`: 서브넷 2개가 붙어 있음(보통 외부망용).
- `public`이 외부 네트워크로 올바르게 설정돼 있어(is_external: true) **플로팅 IP 발급·연결이 가능한 상태**

**(2) 라우터와 내부 서브넷 연결 확인** 

```bash
openstack router list

openstack router show <ROUTER_ID> -f json | jq '{name:.name,id:.id,external_net: .external_gateway_info.network_id,interfaces: [.interfaces_info[].subnet_id]}'

openstack router show router1 -c external_gateway_info -f json
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%206.png)

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%207.png)

- router1 라우터가 정상 동작 중
- external_net 값이 **public 네트워크 ID**와 동일 → 이 라우터는 public(External)에 게이트웨이로 연결됨.
- `private 서브넷들 ↔ router1 ↔ public(External)`

**(3) 플로팅 IP 풀 동작 확인**

```bash
openstack floating ip list

openstack subnet list --network public -c ID -c Name -c CIDR

openstack subnet show <서브넷ID> -c allocation_pools -c gateway_ip -c cidr -f yaml
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%208.png)

public 네트워크에 **두 개의 서브넷**이 있다. 

- **ipv6-public-subnet** : 2001:db8::/64 (IPv6)
- **public-subnet** : 172.24.4.0/24 (IPv4)

**풀 용량 확인**

- ipv6 → 사실상 `/64` 거의 전체가 풀로 열려 있음
- ipv4 → `172.24.4.2` ~ `172.24.4.254` 이므로 253개

**(추가) IPv4 FIP 발급 (예약)**

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%209.png)

---

### 2-4. 프로젝트 쿼터 / 사용량 확인

```bash
openstack quota show
```

![image.png]((5)%20%EC%9E%90%EC%9B%90%20%EA%B4%80%EB%A6%AC%20%EC%A4%80%EB%B9%84%2025ce19595aec80b3b35edc7a28d15e5a/image%2010.png)