# (6) 자원 관리: 설계

담당자: 이지수
진행 상태: 완료
프로젝트: 인프라 관리 솔루션 (https://www.notion.so/223e19595aec8024bd98e7341e341b90?pvs=21)
선행 작업: (5) 자원 관리: 준비 (https://www.notion.so/5-25ce19595aec80b3b35edc7a28d15e5a?pvs=21)
후속 작업: (7) 자원 관리: 학기 시작_자원 초기 할당 (https://www.notion.so/7-_-25ce19595aec804291aee87c0f67a888?pvs=21)

## 0. 작업 배경

[(5) 자원 관리: 준비](https://www.notion.so/5-25ce19595aec80b3b35edc7a28d15e5a?pvs=21)

앞선 작업에서는 자원 할당에 필요한 부트스트랩을 설정하였다. 

자원 할당을 위한 Go API를 개발하기 전, 요구 사항에 알맞은 시스템 설계가 필요하다.

> **인프라 관리 시스템 요구 사항**
> 
> - 사용자(account) 관리 프로그램
>     - 기본 정보: 학번, 이름, 이메일, 학과
> 
> - 자원 할당(quota) 조정 프로그램
>     - 기본 자원 할당: vCPU 8개, vMEM 16G, Disk ??
>     - 학과 수업 별로 필요 자원 요청
>         - 수강 학생들에 대해서 학번 기반으로 자원 할당 조정
>         - 종강 후 해당 학생들에 대해서 자원 재조정 필요 (프로그램 구현 시 이 부분 고려해야 함)

---

## 1. 프로젝트 및 VM 자원 할당 모델 설계

### **(1) 모델 A: 수업당 프로젝트 1개 + 학생별 VM**

- **장점**
    - 교수/조교가 수업 전체 자원을 한곳에서 관리·집계하기 쉬움.
    - 종강 시 한 프로젝트만 정리하면 됨.
- **단점**
    - OpenStack 쿼터는 **프로젝트 단위** → 학생별 한도 보장이 어려움(자원 경쟁).
    - 같은 프로젝트 사용자 간 **리소스 간섭(보기/삭제)** 가능성 존재

### **(2) 모델 B: 학생당 프로젝트 1개**

- **장점**
    - **완전 격리**(VM/네트워크/FIP/볼륨) + **학생별 쿼터**를 바로 적용 가능.
    - 리소스 간섭 위험 없음, 감사/추적/오프보딩(종강 후 회수) 단순.
- **단점**
    - 프로젝트 수 증가 → **자동화(bootstrap API/배치)** 필요.

### **(3) 모델 B로 선정**

- 가이드라인 부합
- **보안·격리**: 서로 다른 프로젝트로 완전 분리 → 타 학생 VM/리소스 간섭 불가.
- **쿼터 정밀도**: 쿼터가 프로젝트 단위이므로, 학생별로 정확히 자원(코어/RAM/FIP/볼륨) 배분 가능.

## 2. DB 설계 및 연동

### 2-1. 테이블 생성

- **students** - 학생 정보 + Keystone 프로젝트 ID
- **courses** - 수업 정보 + 쿼타 프로파일 + 기본값
- **enrollments** - 수강 관계 + 상태 + 기간

**(1) students table**

```sql
CREATE TABLE students (
    student_id TEXT PRIMARY KEY,           -- 학번 (프로젝트 ID로도 사용)
    name TEXT NOT NULL,                    -- 학생 이름
    email TEXT NOT NULL,                   -- 이메일
    department TEXT NOT NULL,              -- 학과
    keystone_project_id TEXT NOT NULL,     -- OpenStack 프로젝트 ID (필수)
    keystone_user_id TEXT,                 -- OpenStack 사용자 ID (선택)
    created_at TIMESTAMPTZ DEFAULT now()   -- 생성 시간
);

```

| 필드명 | 타입 | 제약조건 | 설명 | 예시 |
| --- | --- | --- | --- | --- |
| student_id | TEXT | PRIMARY KEY | 학번 (프로젝트 ID로도 사용) | `"2024001"` |
| name | TEXT | NOT NULL | 학생 이름 | `"홍길동"` |
| email | TEXT | NOT NULL | 이메일 주소 | `"hong@university.ac.kr"` |
| department | TEXT | NOT NULL | 소속 학과 | `"컴퓨터공학과"` |
| keystone_project_id | TEXT | NOT NULL | OpenStack 프로젝트 ID | `"student-2024001-project"` |
| keystone_user_id | TEXT | NULL | OpenStack 사용자 ID | `"student-2024001-user"` |
| created_at | TIMESTAMPTZ | DEFAULT now() | 레코드 생성 시간 | `"2025-01-15T10:30:00Z` |

```json
{
  "student_id": "2024001",
  "name": "홍길동",
  "email": "hong@university.ac.kr",
  "department": "컴퓨터공학과",
  "keystone_project_id": "student-2024001-project",
  "keystone_user_id": "student-2024001-user",
  "created_at": "2025-01-15T10:30:00Z"
}

```

**(2) courses table**

```sql
CREATE TABLE courses (
    course_id TEXT PRIMARY KEY,            -- 수업 ID (예: CC-2025-1)
    title TEXT NOT NULL,                   -- 수업 제목
    department TEXT NOT NULL,              -- 학과
    semester TEXT NOT NULL,                -- 학기
    start_at TIMESTAMPTZ NOT NULL,         -- 수업 시작일
    end_at TIMESTAMPTZ NOT NULL,           -- 수업 종료일
    quota_profile JSONB NOT NULL,          -- 쿼타 프로파일 (필수)
    defaults JSONB,                        -- 기본 설정 (선택)
    created_at TIMESTAMPTZ DEFAULT now()   -- 생성 시간
);

```

| 필드명 | 타입 | 제약조건 | 설명 | 예시 |
| --- | --- | --- | --- | --- |
| course_id | TEXT | PRIMARY KEY | 수업 고유 ID | `"CC-2025-1"` |
| title | TEXT | NOT NULL | 수업 제목 | `"클라우드 컴퓨팅"` |
| department | TEXT | NOT NULL | 개설 학과 | `"컴퓨터공학과"` |
| semester | TEXT | NOT NULL | 학기 정보 | `"2025-1"` |
| start_at | TIMESTAMPTZ | NOT NULL | 수업 시작일 | `"2025-03-01T00:00:00Z"` |
| end_at | TIMESTAMPTZ | NOT NULL | 수업 종료일 | `"2025-06-30T23:59:59Z"` |
| quota_profile | JSONB | NOT NULL | 자원 할당량 정의 | `{"instances": 2, "cores": 4, ...}` |
| defaults | JSONB | NULL | 기본 환경 설정 | `{"imageId": "ubuntu-20.04", ...}` |
| created_at | TIMESTAMPTZ | DEFAULT now() | 레코드 생성 시간 | `"2025-01-15T10:30:00Z"` |

```json
// quota_profile JSONB
****{
  "instances": 2,      // VM 인스턴스 수
  "cores": 4,          // CPU 코어 수
  "ramMB": 8192,       // RAM (MB)
  "volumes": 2,        // 볼륨 수
  "gigabytes": 100,    // 디스크 용량 (GB)
  "ports": 2,          // 네트워크 포트 수
  "floatingIPs": 1     // 플로팅 IP 수
}

```

```json
// defaults JSONB
{
  "imageId": "ubuntu-20.04",           // 기본 이미지
  "flavorIds": ["m1.medium", "m1.large"], // 사용 가능한 플레이버
  "networkId": "private-network",      // 기본 네트워크
  "externalNetworkID": "public-network", // 외부 네트워크
  "securityGroup": "default-sg",       // 보안 그룹
  "bootFromVolume": true,              // 볼륨 부팅 여부
  "rootVolumeGB": 50                   // 루트 볼륨 크기
}

```

```json
{
  "course_id": "CC-2025-1",
  "title": "클라우드 컴퓨팅",
  "department": "컴퓨터공학과",
  "semester": "2025-1",
  "start_at": "2025-03-01T00:00:00Z",
  "end_at": "2025-06-30T23:59:59Z",
  "quota_profile": {
    "instances": 2,
    "cores": 4,
    "ramMB": 8192,
    "volumes": 2,
    "gigabytes": 100,
    "ports": 2,
    "floatingIPs": 1
  },
  "defaults": {
    "imageId": "ubuntu-20.04",
    "flavorIds": ["m1.medium", "m1.large"],
    "networkId": "private-network",
    "externalNetworkID": "public-network",
    "securityGroup": "default-sg",
    "bootFromVolume": true,
    "rootVolumeGB": 50
  },
  "created_at": "2025-01-15T10:30:00Z"
}

```

**(3) enrollments table**

```sql
CREATE TABLE enrollments (
    student_id TEXT NOT NULL REFERENCES students(student_id) ON DELETE CASCADE,
    course_id TEXT NOT NULL REFERENCES courses(course_id) ON DELETE CASCADE,
    status TEXT NOT NULL CHECK (status IN ('active', 'completed', 'dropped')),
    start_at TIMESTAMPTZ NOT NULL,         -- 수강 시작일
    end_at TIMESTAMPTZ NOT NULL,           -- 수강 종료일
    PRIMARY KEY (student_id, course_id)    -- 복합 기본키
);

```

| 필드명 | 타입 | 제약조건 | 설명 | 예시 |
| --- | --- | --- | --- | --- |
| student_id | TEXT | NOT NULL + FK | 학생 ID (students 테이블 참조) | `"2024001"` |
| course_id | TEXT | NOT NULL + FK | 수업 ID (courses 테이블 참조) | `"CC-2025-1"` |
| status | TEXT | NOT NULL + CHECK | 수강 상태 | `"active"`, `"completed"`, `"dropped"` |
| start_at | TIMESTAMPTZ | NOT NULL | 수강 시작일 | `"2025-03-01T00:00:00Z"` |
| end_at | TIMESTAMPTZ | NOT NULL | 수강 종료일 | `"2025-06-30T23:59:59Z"` |

**외래키 제약 조건** 

- student_id → students.student_id (CASCADE DELETE)
- course_id → courses.course_id (CASCADE DELETE)

**status 상태별 의미**

| 상태 | 설명 | 자원 할당 |
| --- | --- | --- |
| active | 현재 수강 중인 과목 | ✅ 자원 할당 대상 |
| completed | 수강 완료된 과목 | ❌ 자원 해제 대상 |
| dropped | 수강 철회된 과목 | ❌ 자원 해제 대상 |

```json
{
  "student_id": "2024001",
  "course_id": "CC-2025-1",
  "status": "active",
  "start_at": "2025-03-01T00:00:00Z",
  "end_at": "2025-06-30T23:59:59Z"
}
```

**(4) 테이블 간 관계**

1. 학생 1명 → 여러 수업 수강 (1:N)
2. 수업 1개 → 여러 학생 수강 (1:N)
3. enrollments는 **students와 courses**를 연결하는 중간 테이블
4. 학생의 최종 쿼타 = 모든 활성 수강의 쿼타 합산

---

### 2-2. Postgres DB 연동

```bash
docker run -d \
  --name postgres-quota \
  -e POSTGRES_DB=quota_db \
  -e POSTGRES_USER=quota_user \
  -e POSTGRES_PASSWORD=quota_password \
  -p 5432:5432 \
  postgres:15
 
 docker ps
 
 docker exec -it postgres-quota psql -U quota_user -d quota_db
```

---

## 3. 시스템 동작 시나리오 설계

### **3-1. [시나리오 1] 학기 시작**

대량 자원 초기 할당 

모든 수강생에게 과목 프로파일을 반영해 유효 쿼터를 설정

**(1) 입력/데이터**

- **courses**: `course_id, title, department, semester, start_at, end_at, quota_profile(JSONB), defaults(JSONB)`
- **students**: `student_id, name, email, department, keystone_project_id`
    - 프로젝트가 없으면 생성 후 `keystone_project_id` 저장
- **enrollments**: `(student_id, course_id, status='active', start_at, end_at)` 대량 입력

**(2) 처리 절차**

1. 과목/기간/프로파일 등록 (courses)
2. 학생 등록 및 프로젝트 부트스트랩(최초 1회)
3. 수강(활성) 데이터 적재 (enrollments)
4. 대량 리콘실: 학생별 활성 과목을 그룹핑하여 `유효쿼터 = baseline + Σ(활성 과목 quota)` 계산
5. OpenStack 쿼터 적용
    - **Nova**: `instances, cores, ram`
    - **Neutron**: `ports, floating_ips`
    - **Cinder**: `volumes, gigabytes`
6. 결과 기록(성공/실패 건수, 학생별 최종 쿼터)

**(3) 상태**

각 학생 프로젝트에 유효 쿼터 반영 완료

---

### 3-2. [시나리오 2] 수강 변경

동적 자원 **재조정**

**(1) 트리거** 

- `POST /students/{id}/enroll` (추가)
- `DELETE /students/{id}/enroll/{courseId}` (철회)
- `PUT /students/{id}/enroll/{courseId}` (상태 변경: active ↔ completed/dropped)

**(2) 처리 절차**

1. 변경 내용을 enrollments에 반영
2. 해당 **학생만** 온디맨드 리콘실 실행
    - 현재 활성 과목(기간 포함) 조회
    - 유효쿼터 재계산 `baseline + Σ(활성 과목 quota)`
3. OpenStack 쿼터 증감 적용
    - 증액: 즉시 적용
    - 감액: **현재 사용량 이하로만** 내림(초과 사용분은 유지, 신규 생성만 제한)

---

### 3-3. [시나리오 3] 자원 할당(프로비저닝)

자원 할당

과목 기본값(이미지/플레이버/네트워크 등)과 학생별 정책을 바탕으로 **실제 VM을 생성**하고, 필요 시 **FIP를 연결**

- **프로젝트 확인/보장(ensure)**
    - `students.keystone_project_id` 확인, 없으면 생성 후 DB 저장.
    - 프로젝트 스코프 토큰 준비.
- **프리플라이트(필수 자원/쿼터 체크)**
    - 키페어/보안그룹/네트워크 ID 유효성 확인.
    - **현재 사용량 vs 쿼터** 확인(ports/FIP 포함) → 부족 시 에러 반환 또는 자동 증설 정책.
    - 멱등키(`clientToken` 헤더)로 **중복 생성 방지**.
- **VM 생성**
    - **이미지 직부팅** 또는 **부팅 볼륨 생성 후 부팅**(defaults.bootFromVolume에 따라)
    - NIC: `networkId`로 포트 자동 생성(필요 시 고정 IP/다중 NIC).
    - SG: `securityGroups` 적용.
    - cloud-init `userData` 주입.
    - `ACTIVE` 대기(타임아웃/백오프).
- **FIP 할당(옵션)**
    - `assignFloatingIp=true`일 때:
        - 남는 FIP 있으면 **재사용**, 없으면 **신규 발급**(quota 내).
        - 인스턴스의 primary 포트에 **associate**.
    - 실패 시: VM은 유지하고 FIP만 미할당 상태로 응답(부분 성공 정책).
- **기록/태깅**
    - 리소스에 태그: `owner=32210006`, `course=CC-2025-1`.
    - DB에 인스턴스 메타 저장(테이블이 없다면 `prov_requests`에 최소 기록).

---

### 3-4. [시나리오 4] 학기 종료

자원 회수

**(1) 트리거**

각 수강(enrollment)의 `end_at` **도달 시 즉시**(스케줄러가 실행).

**(2) 처리 절차**

1. 해당 수강의 상태를 `completed`로 마크
2. 학생의 **유효쿼터 재계산**(종료 과목 제외).
3. OpenStack 쿼터 **감액 적용**
    - **Nova**: 인스턴스/코어/RAM 상한 축소(사용 중인 자원은 유지).
    - **Neutron**: 필요 시 FIP 회수 정책 실행
    - **Cinder**: gigabytes/volumes 축소(초과 사용 시 알림/유예 후 정리).